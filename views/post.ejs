<h1><%= data.title %></h1>
<article class="article"><%- data.body %></article>

<div id="likeActions">
  <button id="likeButton">Like</button>
  <button id="dislikeButton">Dislike</button>
  <p id="likeStatus"></p>
</div>

<div id="commentSection">
  <h3>Comments</h3>
  <div id="commentsList">
    <!-- Comments will be dynamically loaded here -->
  </div>
  <div id="commentForm">
    <textarea id="commentInput" placeholder="Write your comment..."></textarea>
    <button id="submitCommentButton">Submit</button>
  </div>
</div>

<div id="chatContainer">
  <div id="chatToggle">
    <button id="toggleChatButton">Ask ?</button>
  </div>
  <div id="chatWindow" style="display: none">
    <!-- Chat window hidden by default -->
    <div id="chatMessages">
      <!-- Chat messages will be appended here -->
    </div>
    <div id="inputContainer">
      <!-- New container for input and button -->
      <input type="text" id="userInput" placeholder="Type your question..." />
      <button id="sendButton">Send</button>
    </div>
  </div>
</div>
<script>
  const blogId = "<%= data._id %>"; // Get the blog ID dynamically

  // Function to check if the user has already liked or disliked the post
  async function checkLikeStatus() {
    try {
      const response = await fetch(`/likes/check/${blogId}`, {
        method: "GET",
        headers: {
          "Content-Type": "application/json",
        },
      });

      if (response.ok) {
        const data = await response.json();
        if (data.liked) {
          // Hide both buttons if the user has already liked or disliked
          document.getElementById("likeButton").style.display = "none";
          document.getElementById("dislikeButton").style.display = "none";
          document.getElementById("likeStatus").innerText =
            "You already liked or disliked this post.";
        }
      }
    } catch (err) {
      console.error("Error checking like status:", err);
    }
  }

  // Call checkLikeStatus to check on page load if the user has liked or disliked the post
  window.onload = checkLikeStatus;

  // Like button functionality
  document.getElementById("likeButton").addEventListener("click", async () => {
    try {
      const response = await fetch(`/likes/like/${blogId}`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
      });

      if (response.ok) {
        const result = await response.json();
        document.getElementById("likeStatus").innerText =
          "You liked this post!";
        checkLikeStatus(); // Recheck the status after liking
      } else {
        const error = await response.json();
        document.getElementById("likeStatus").innerText = error.message;
      }
    } catch (err) {
      document.getElementById("likeStatus").innerText =
        "Error liking the post.";
    }
  });

  // Dislike button functionality
  document
    .getElementById("dislikeButton")
    .addEventListener("click", async () => {
      try {
        const response = await fetch(`/likes/dislike/${blogId}`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
        });

        if (response.ok) {
          const result = await response.json();
          document.getElementById("likeStatus").innerText =
            "You disliked this post!";
          checkLikeStatus(); // Recheck the status after disliking
        } else {
          const error = await response.json();
          document.getElementById("likeStatus").innerText = error.message;
        }
      } catch (err) {
        document.getElementById("likeStatus").innerText =
          "Error disliking the post.";
      }
    });

  // Chat functionality
  const messages = []; // Initialize an array to store chat messages

  // Toggle chat visibility
  document.getElementById("toggleChatButton").onclick = function () {
    const chatWindow = document.getElementById("chatWindow");
    chatWindow.style.display =
      chatWindow.style.display === "none" ? "block" : "none"; // Toggle chat visibility
  };

  document.getElementById("sendButton").onclick = async function () {
    const userInput = document.getElementById("userInput").value.trim();

    if (!userInput) return; // Prevent sending empty messages

    // Display the user's message
    appendMessage("You", userInput);
    messages.push({ role: "user", content: userInput });

    // Send the user's input to the server
    const response = await fetch("/chat", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({ id: blogId, content: userInput }),
    });

    const data = await response.json();

    // Display the assistant's response
    appendMessage("Assistant", data.msg);
    messages.push({ role: "assistant", content: data.msg });

    // Clear the input field
    document.getElementById("userInput").value = "";

    // Scroll to the bottom of the chat
    const chatMessages = document.getElementById("chatMessages");
    chatMessages.scrollTop = chatMessages.scrollHeight;
  };

  function appendMessage(sender, content) {
    const chatMessages = document.getElementById("chatMessages");
    const messageDiv = document.createElement("div");
    messageDiv.innerHTML = `<strong>${sender}:</strong> ${content}`;
    chatMessages.appendChild(messageDiv);
  }

  const commentsApiUrl = "/comment"; // API endpoint for comments

  // Load comments for the blog post
  async function loadComments() {
    try {
      const response = await fetch(`${commentsApiUrl}/${blogId}`, {
        method: "GET",
        headers: { "Content-Type": "application/json" },
      });

      if (response.ok) {
        const comments = await response.json();
        const commentsList = document.getElementById("commentsList");
        commentsList.innerHTML = ""; // Clear existing comments
        comments.forEach((comment) => {
          const commentDiv = document.createElement("div");
          commentDiv.className = "comment";
          commentDiv.innerHTML = `<strong>${comment.userName}:</strong> ${comment.content}`;
          commentsList.appendChild(commentDiv);
        });
      } else {
        console.error("Failed to load comments");
      }
    } catch (err) {
      console.error("Error loading comments:", err);
    }
  }

  // Handle comment submission
  document
    .getElementById("submitCommentButton")
    .addEventListener("click", async () => {
      const commentInput = document.getElementById("commentInput");
      const commentContent = commentInput.value.trim();

      if (!commentContent) {
        alert("Comment cannot be empty");
        return;
      }

      try {
        const response = await fetch(commentsApiUrl, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ blogId, content: commentContent }),
        });

        if (response.ok) {
          commentInput.value = ""; // Clear the input field
          loadComments(); // Reload comments
        } else {
          const error = await response.json();
          alert(`Error: ${error.message}`);
        }
      } catch (err) {
        console.error("Error submitting comment:", err);
      }
    });

  // Load comments on page load
  loadComments();
</script>

<style>
  #likeActions {
    margin: 20px 0;
    text-align: center;
  }

  #likeButton,
  #dislikeButton {
    background-color: #28a745; /* Green color */
    color: white;
    border: none;
    padding: 10px 15px;
    margin: 5px;
    cursor: pointer;
    border-radius: 5px;
  }

  #likeButton:hover {
    background-color: #218838; /* Darker green */
  }

  #dislikeButton {
    background-color: #dc3545; /* Red color */
    color: white;
    border: none;
    padding: 10px 15px;
    margin: 5px;
    cursor: pointer;
    border-radius: 5px;
  }

  #dislikeButton:hover {
    background-color: #c82333; /* Darker red */
  }

  #likeStatus {
    margin-top: 10px;
    font-weight: bold;
    color: #333;
  }

  #chatContainer {
    position: fixed;
    right: 20px;
    bottom: 20px;
    width: 400px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
    border-radius: 8px;
    z-index: 1000;
  }

  #chatToggle {
    display: flex;
    justify-content: center;
    background-color: #007bff;
    border-radius: 8px 8px 0 0;
  }

  #toggleChatButton {
    background-color: #007bff;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    cursor: pointer;
  }

  #toggleChatButton:hover {
    background-color: #0056b3;
  }

  #chatWindow {
    background-color: #f0f8ff;
    border: 1px solid #007bff;
    border-radius: 0 0 8px 8px;
    display: flex;
    flex-direction: column;
    height: 400px;
  }

  #chatMessages {
    flex-grow: 1;
    padding: 10px;
    overflow-y: auto; /* Enable vertical scrolling */
    background-color: #e6f7ff;
    font-family: "Arial", sans-serif;
    color: #333;
    max-height: 300px; /* Limit the height */
  }

  #inputContainer {
    display: flex;
    justify-content: center;
    margin: 10px;
  }

  #userInput {
    padding: 5px;
    border: 1px solid #007bff;
    border-radius: 4px;
    margin-right: 10px;
    font-family: "Comic Sans MS", cursive;
    color: #007bff;
    width: 300px;
  }

  #sendButton {
    background-color: #007bff;
    color: white;
    border: none;
    padding: 10px 15px;
    border-radius: 4px;
    cursor: pointer;
  }

  #sendButton:hover {
    background-color: #0056b3;
  }

  strong {
    color: #007bff;
  }

  /* Custom scroll bar styling for WebKit browsers */
  #chatMessages::-webkit-scrollbar {
    width: 8px;
  }

  #chatMessages::-webkit-scrollbar-thumb {
    background-color: #007bff;
    border-radius: 4px;
  }

  #chatMessages::-webkit-scrollbar-thumb:hover {
    background-color: #0056b3;
  }

  #chatMessages::-webkit-scrollbar-track {
    background: #e6f7ff;
  }

  /* Scrollbar styling for Firefox */
  #chatMessages {
    scrollbar-width: thin;
    scrollbar-color: #007bff #e6f7ff;
  }
  #commentSection {
    margin-top: 20px;
    padding: 15px;
    background-color: #f9f9f9;
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
  }

  h3 {
    font-size: 1.5rem;
    color: #333;
    margin-bottom: 15px;
  }

  #commentsList {
    margin-bottom: 20px;
    max-height: 300px;
    overflow-y: auto;
  }

  #commentsList .comment {
    padding: 12px;
    background-color: #fff;
    border-radius: 6px;
    border-bottom: 1px solid #ddd;
    margin-bottom: 10px;
    transition: background-color 0.3s ease;
  }

  #commentsList .comment:hover {
    background-color: #f1f1f1;
  }

  #commentsList .comment:last-child {
    border-bottom: none;
  }

  #commentForm {
    display: flex;
    flex-direction: column;
  }

  #commentInput {
    padding: 10px;
    margin-bottom: 15px;
    width: 100%;
    border: 1px solid #007bff;
    border-radius: 6px;
    font-size: 1rem;
    resize: none;
  }

  #submitCommentButton {
    align-self: flex-end;
    background-color: #007bff;
    color: white;
    border: none;
    padding: 10px 15px;
    border-radius: 6px;
    font-size: 1rem;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }

  #submitCommentButton:hover {
    background-color: #0056b3;
  }

  #submitCommentButton:disabled {
    background-color: #ccc;
    cursor: not-allowed;
  }
</style>
